<!--
 * *****************************************************************************
 * Copyright (C) 2025 Thinline Dynamic Solutions
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>
 * ****************************************************************************
-->
<ng-container [formGroup]="form">

<!-- ══════════════════════════════════════════════════════════════
     System Header
══════════════════════════════════════════════════════════════ -->
<div class="system-detail-header">
    <div class="system-title">
        <mat-icon>podcasts</mat-icon>
        <div>
            <h3>{{ $any(form.value).label?.trim() || 'New System' }}</h3>
            <span class="system-subtitle">
                ID: {{ $any(form.value).systemRef || '—' }}
                <ng-container *ngIf="$any(form.value).type"> · {{ $any(form.value).type | uppercase }}</ng-container>
            </span>
        </div>
        <mat-icon *ngIf="form.invalid" color="warn" class="header-error"
                  [matTooltip]="'Validation errors: ' + getTalkgroupsErrorSummary()">error</mat-icon>
    </div>
    <button type="button" mat-stroked-button color="warn" (click)="remove.emit()">
        <mat-icon>delete</mat-icon> Delete System
    </button>
</div>

<!-- ══════════════════════════════════════════════════════════════
     System Settings
══════════════════════════════════════════════════════════════ -->
<div class="settings-card">
    <h4 class="section-label"><mat-icon>settings</mat-icon> System Settings</h4>
    <div class="settings-grid">

        <div class="settings-field">
            <label class="field-label">System ID</label>
            <mat-form-field appearance="outline" class="compact-field">
                <input type="number" min="1" step="1" matInput formControlName="systemRef" placeholder="e.g. 100">
                <mat-error *ngIf="form.get('systemRef')?.hasError('duplicate')">ID already defined</mat-error>
                <mat-error *ngIf="form.get('systemRef')?.hasError('min')">ID is invalid</mat-error>
                <mat-error *ngIf="form.get('systemRef')?.hasError('required')">ID is required</mat-error>
            </mat-form-field>
        </div>

        <div class="settings-field">
            <label class="field-label">Label</label>
            <mat-form-field appearance="outline" class="compact-field">
                <input type="text" matInput formControlName="label" placeholder="System name">
                <mat-error *ngIf="form.get('label')?.hasError('required')">Label is required</mat-error>
            </mat-form-field>
        </div>

        <div class="settings-field">
            <label class="field-label">Type</label>
            <mat-form-field appearance="outline" class="compact-field">
                <mat-select formControlName="type" placeholder="Type">
                    <mat-option value="">No Type</mat-option>
                    <mat-option value="am">AM</mat-option>
                    <mat-option value="dmr">DMR</mat-option>
                    <mat-option value="fm">FM</mat-option>
                    <mat-option value="nfm">NFM</mat-option>
                    <mat-option value="nxdn">NXDN</mat-option>
                    <mat-option value="p25">P25</mat-option>
                    <mat-option value="provoice">Provoice</mat-option>
                    <mat-option value="smartnet">SmartNet</mat-option>
                    <mat-option value="tetra">Tetra</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="settings-field">
            <label class="field-label">Delay (min)</label>
            <mat-form-field appearance="outline" class="compact-field">
                <input type="number" min="0" step="1" matInput formControlName="delay" placeholder="0">
            </mat-form-field>
        </div>

        <div class="settings-field settings-field--toggle">
            <label class="field-label">Auto Populate</label>
            <mat-slide-toggle color="primary" formControlName="autoPopulate"></mat-slide-toggle>
            <span class="mat-caption toggle-hint">Auto-create unconfigured talkgroups</span>
        </div>

        <div class="settings-field settings-field--wide">
            <label class="field-label">Blacklists</label>
            <mat-form-field appearance="outline" class="compact-field">
                <textarea matInput formControlName="blacklists" placeholder="Comma-separated talkgroup IDs to blacklist" rows="2"></textarea>
                <mat-error *ngIf="form.get('blacklists')?.hasError('invalid')">Comma separated list of talkgroup IDs</mat-error>
            </mat-form-field>
        </div>

        <div class="settings-field settings-field--wide">
            <label class="field-label">Preferred API Key</label>
            <mat-form-field appearance="outline" class="compact-field">
                <mat-select formControlName="preferredApiKeyId" placeholder="Any API Key">
                    <mat-option [value]="null">Any API Key (No Restriction)</mat-option>
                    <mat-option *ngFor="let apikey of apikeys" [value]="apikey.id">
                        {{ apikey.ident || 'API Key ' + apikey.id }}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>

    </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     Talkgroups
══════════════════════════════════════════════════════════════ -->
<div class="sub-section">
    <div class="sub-section-header">
        <div class="sub-section-title">
            <mat-icon>record_voice_over</mat-icon>
            <h4>Talkgroups</h4>
            <span class="count-chip">{{ talkgroups.length }}</span>
            <mat-icon *ngIf="form.get('talkgroups')?.invalid" color="warn" class="section-error"
                      [matTooltip]="getTalkgroupsErrorSummary()">error</mat-icon>
        </div>
        <div class="sub-section-actions">
            <button type="button" mat-raised-button color="primary" (click)="addTalkgroup()">
                <mat-icon>add</mat-icon> Add Talkgroup
            </button>
            <button type="button" mat-stroked-button (click)="sortTalkgroupsAlphabetically()"
                    [disabled]="talkgroups.length === 0" matTooltip="Sort talkgroups A–Z">
                <mat-icon>sort_by_alpha</mat-icon> Sort A–Z
            </button>
        </div>
    </div>

    <!-- Search -->
    <div class="table-search-bar" *ngIf="talkgroups.length > 5">
        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search talkgroups</mat-label>
            <input matInput [value]="talkgroupsSearchTerm"
                   (input)="onTalkgroupsSearchChange($any($event.target).value)"
                   placeholder="ID, label, or name">
            <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        <span *ngIf="talkgroupsSearchTerm" class="mat-caption search-count">
            {{ filteredTalkgroups.length }} of {{ talkgroups.length }}
        </span>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-toolbar" *ngIf="talkgroups.length > 0">
        <button type="button" mat-button (click)="selectAllTalkgroups()" [disabled]="allTalkgroupsSelected">
            Select All
        </button>
        <button type="button" mat-button (click)="unselectAllTalkgroups()" [disabled]="!hasSelectedTalkgroups">
            Deselect All
        </button>
        <span class="mat-caption selection-count">{{ selectedTalkgroupIndices.size }} selected</span>

        <ng-container *ngIf="hasSelectedTalkgroups">
            <mat-form-field appearance="outline" class="bulk-select">
                <mat-label>Group</mat-label>
                <mat-select [(value)]="bulkAssignGroupId">
                    <mat-option [value]="null">— Select Group —</mat-option>
                    <mat-option *ngFor="let group of groups" [value]="group.id">{{ group.label }}</mat-option>
                </mat-select>
            </mat-form-field>
            <button type="button" mat-raised-button color="primary" (click)="bulkAssignGroup()" [disabled]="bulkAssignGroupId === null">Add Group</button>
            <button type="button" mat-stroked-button color="warn" (click)="bulkRemoveGroup()" [disabled]="bulkAssignGroupId === null">Remove Group</button>

            <mat-form-field appearance="outline" class="bulk-select">
                <mat-label>Tag</mat-label>
                <mat-select [(value)]="bulkAssignTagId">
                    <mat-option [value]="null">— Select Tag —</mat-option>
                    <mat-option *ngFor="let tag of tags" [value]="tag.id">{{ tag.label }}</mat-option>
                </mat-select>
            </mat-form-field>
            <button type="button" mat-raised-button color="primary" (click)="bulkAssignTag()" [disabled]="bulkAssignTagId === null">Assign Tag</button>
        </ng-container>
    </div>

    <!-- Empty State -->
    <div *ngIf="talkgroups.length === 0" class="sub-empty">
        <mat-icon>record_voice_over</mat-icon>
        <p>No talkgroups defined for this system.</p>
    </div>

    <!-- Talkgroups Table -->
    <div class="table-wrapper" *ngIf="talkgroups.length > 0">
        <mat-table [dataSource]="filteredTalkgroups"
                   multiTemplateDataRows
                   cdkDropList
                   [cdkDropListData]="filteredTalkgroups"
                   (cdkDropListDropped)="dropTalkgroup($event)"
                   class="data-table talkgroups-table">

            <!-- Select Column -->
            <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef class="select-col">
                    <mat-checkbox
                        [checked]="allTalkgroupsSelected"
                        [indeterminate]="hasSelectedTalkgroups && !allTalkgroupsSelected"
                        (change)="allTalkgroupsSelected ? unselectAllTalkgroups() : selectAllTalkgroups()"
                        (click)="$event.stopPropagation()">
                    </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let tg; let i = index" class="select-col">
                    <mat-checkbox
                        [checked]="isTalkgroupSelected(i)"
                        (change)="toggleTalkgroupSelection(i)"
                        (click)="$event.stopPropagation()">
                    </mat-checkbox>
                </td>
            </ng-container>

            <!-- Drag Column -->
            <ng-container matColumnDef="drag">
                <th mat-header-cell *matHeaderCellDef class="drag-col"></th>
                <td mat-cell *matCellDef="let tg" class="drag-col">
                    <mat-icon cdkDragHandle class="drag-handle" (click)="$event.stopPropagation()">drag_indicator</mat-icon>
                </td>
            </ng-container>

            <!-- ID Column -->
            <ng-container matColumnDef="talkgroupRef">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let tg">
                    <code class="id-code">{{ tg.value.talkgroupRef || '—' }}</code>
                </td>
            </ng-container>

            <!-- Label Column -->
            <ng-container matColumnDef="label">
                <th mat-header-cell *matHeaderCellDef>Label</th>
                <td mat-cell *matCellDef="let tg">
                    <span class="tg-label">{{ tg.value.label?.trim() || '—' }}</span>
                    <mat-icon *ngIf="tg.invalid" color="warn" class="row-error"
                              [matTooltip]="getTalkgroupErrors(tg)">error</mat-icon>
                </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>Name</th>
                <td mat-cell *matCellDef="let tg">
                    <span class="tg-name">{{ tg.value.name?.trim() || '—' }}</span>
                </td>
            </ng-container>

            <!-- Groups Column -->
            <ng-container matColumnDef="groups">
                <th mat-header-cell *matHeaderCellDef>Groups</th>
                <td mat-cell *matCellDef="let tg">
                    <div class="chip-list">
                        <span class="mini-chip" *ngFor="let label of getGroupLabels(tg.value.groupIds)">{{ label }}</span>
                        <span class="no-value" *ngIf="!tg.value.groupIds?.length">—</span>
                    </div>
                </td>
            </ng-container>

            <!-- Tag Column -->
            <ng-container matColumnDef="tag">
                <th mat-header-cell *matHeaderCellDef>Tag</th>
                <td mat-cell *matCellDef="let tg">
                    <span class="tag-chip" *ngIf="getTagLabel(tg.value.tagId)">{{ getTagLabel(tg.value.tagId) }}</span>
                    <span class="no-value" *ngIf="!getTagLabel(tg.value.tagId)">—</span>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-col"></th>
                <td mat-cell *matCellDef="let tg; let i = index" class="actions-col">
                    <button mat-icon-button [class.active-edit]="expandedTalkgroup === tg"
                            (click)="toggleTalkgroupExpand(tg); $event.stopPropagation()"
                            matTooltip="Edit">
                        <mat-icon>{{ expandedTalkgroup === tg ? 'expand_less' : 'edit' }}</mat-icon>
                    </button>
                    <button mat-icon-button color="warn"
                            (click)="removeTalkgroup(i); $event.stopPropagation()"
                            matTooltip="Delete">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <!-- Expanded Detail Column -->
            <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let tg" [attr.colspan]="talkgroupDisplayedColumns.length" class="detail-cell">
                    <div *ngIf="expandedTalkgroup === tg" class="expanded-form-wrapper">
                        <rdio-scanner-admin-talkgroup
                            [form]="tg"
                            (blacklist)="blacklistTalkgroup(talkgroups.indexOf(tg))"
                            (remove)="removeTalkgroup(talkgroups.indexOf(tg))">
                        </rdio-scanner-admin-talkgroup>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="talkgroupDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: talkgroupDisplayedColumns;"
                class="data-row"
                [class.row-expanded]="expandedTalkgroup === row"
                cdkDrag [cdkDragData]="row"
                (click)="toggleTalkgroupExpand(row)">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail'];" class="detail-row"
                [class.row-hidden]="expandedTalkgroup !== row">
            </tr>

        </mat-table>

    </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     Sites
══════════════════════════════════════════════════════════════ -->
<div class="sub-section">
    <div class="sub-section-header">
        <div class="sub-section-title">
            <mat-icon>cell_tower</mat-icon>
            <h4>Sites</h4>
            <span class="count-chip">{{ sites.length }}</span>
            <mat-icon *ngIf="form.get('sites')?.invalid" color="warn" class="section-error">error</mat-icon>
        </div>
        <button type="button" mat-raised-button color="primary" (click)="addSite()">
            <mat-icon>add</mat-icon> Add Site
        </button>
    </div>

    <div *ngIf="sites.length === 0" class="sub-empty">
        <mat-icon>cell_tower</mat-icon>
        <p>No sites defined. Sites are used for P25 preferred-site duplicate detection.</p>
    </div>

    <div class="table-wrapper" *ngIf="sites.length > 0">
        <mat-table [dataSource]="filteredSites"
                   multiTemplateDataRows
                   cdkDropList
                   [cdkDropListData]="filteredSites"
                   (cdkDropListDropped)="dropSite($event)"
                   class="data-table">

            <!-- Drag Column -->
            <ng-container matColumnDef="drag">
                <th mat-header-cell *matHeaderCellDef class="drag-col"></th>
                <td mat-cell *matCellDef="let site" class="drag-col">
                    <mat-icon cdkDragHandle class="drag-handle" (click)="$event.stopPropagation()">drag_indicator</mat-icon>
                </td>
            </ng-container>

            <!-- Site ID Column -->
            <ng-container matColumnDef="siteRef">
                <th mat-header-cell *matHeaderCellDef>Site ID</th>
                <td mat-cell *matCellDef="let site">
                    <code class="id-code">{{ site.value.siteRef || '—' }}</code>
                </td>
            </ng-container>

            <!-- RFSS Column -->
            <ng-container matColumnDef="rfss">
                <th mat-header-cell *matHeaderCellDef>RFSS</th>
                <td mat-cell *matCellDef="let site">
                    <span class="dim-value">{{ site.value.rfss ?? '—' }}</span>
                </td>
            </ng-container>

            <!-- Label Column -->
            <ng-container matColumnDef="label">
                <th mat-header-cell *matHeaderCellDef>Label</th>
                <td mat-cell *matCellDef="let site">
                    <span class="tg-label">{{ site.value.label?.trim() || '—' }}</span>
                    <mat-icon *ngIf="site.invalid" color="warn" class="row-error">error</mat-icon>
                </td>
            </ng-container>

            <!-- Preferred Column -->
            <ng-container matColumnDef="preferred">
                <th mat-header-cell *matHeaderCellDef>Preferred</th>
                <td mat-cell *matCellDef="let site">
                    <span class="preferred-badge" *ngIf="site.value.preferred">
                        <mat-icon>star</mat-icon> Preferred
                    </span>
                    <span class="no-value" *ngIf="!site.value.preferred">—</span>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-col"></th>
                <td mat-cell *matCellDef="let site; let i = index" class="actions-col">
                    <button mat-icon-button [class.active-edit]="expandedSite === site"
                            (click)="toggleSiteExpand(site); $event.stopPropagation()"
                            matTooltip="Edit">
                        <mat-icon>{{ expandedSite === site ? 'expand_less' : 'edit' }}</mat-icon>
                    </button>
                    <button mat-icon-button color="warn"
                            (click)="removeSite(i); $event.stopPropagation()"
                            matTooltip="Delete">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <!-- Expanded Detail Column -->
            <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let site" [attr.colspan]="siteDisplayedColumns.length" class="detail-cell">
                    <div *ngIf="expandedSite === site" class="expanded-form-wrapper">
                        <rdio-scanner-admin-site
                            [form]="site"
                            (remove)="removeSite(sites.indexOf(site))">
                        </rdio-scanner-admin-site>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="siteDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: siteDisplayedColumns;"
                class="data-row"
                [class.row-expanded]="expandedSite === row"
                cdkDrag [cdkDragData]="row"
                (click)="toggleSiteExpand(row)">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail'];" class="detail-row"
                [class.row-hidden]="expandedSite !== row">
            </tr>

        </mat-table>
    </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     Units
══════════════════════════════════════════════════════════════ -->
<div class="sub-section">
    <div class="sub-section-header">
        <div class="sub-section-title">
            <mat-icon>person_pin</mat-icon>
            <h4>Units</h4>
            <span class="count-chip">{{ units.length }}</span>
            <mat-icon *ngIf="form.get('units')?.invalid" color="warn" class="section-error">error</mat-icon>
        </div>
        <button type="button" mat-raised-button color="primary" (click)="addUnit()">
            <mat-icon>add</mat-icon> Add Unit
        </button>
    </div>

    <div *ngIf="units.length === 0" class="sub-empty">
        <mat-icon>person_pin</mat-icon>
        <p>No units defined. Units map unit IDs to friendly labels on the main screen.</p>
    </div>

    <div class="table-wrapper" *ngIf="units.length > 0">
        <mat-table [dataSource]="filteredUnits"
                   multiTemplateDataRows
                   cdkDropList
                   [cdkDropListData]="filteredUnits"
                   (cdkDropListDropped)="dropUnit($event)"
                   class="data-table">

            <!-- Drag Column -->
            <ng-container matColumnDef="drag">
                <th mat-header-cell *matHeaderCellDef class="drag-col"></th>
                <td mat-cell *matCellDef="let unit" class="drag-col">
                    <mat-icon cdkDragHandle class="drag-handle" (click)="$event.stopPropagation()">drag_indicator</mat-icon>
                </td>
            </ng-container>

            <!-- Unit ID Column -->
            <ng-container matColumnDef="unitRef">
                <th mat-header-cell *matHeaderCellDef>Unit ID</th>
                <td mat-cell *matCellDef="let unit">
                    <code class="id-code">{{ unit.value.unitRef || '—' }}</code>
                </td>
            </ng-container>

            <!-- Label Column -->
            <ng-container matColumnDef="label">
                <th mat-header-cell *matHeaderCellDef>Label</th>
                <td mat-cell *matCellDef="let unit">
                    <span class="tg-label">{{ unit.value.label?.trim() || '—' }}</span>
                    <mat-icon *ngIf="unit.invalid" color="warn" class="row-error">error</mat-icon>
                </td>
            </ng-container>

            <!-- Range Column -->
            <ng-container matColumnDef="range">
                <th mat-header-cell *matHeaderCellDef>Range</th>
                <td mat-cell *matCellDef="let unit">
                    <span *ngIf="unit.value.unitFrom && unit.value.unitTo" class="range-value">
                        {{ unit.value.unitFrom }} – {{ unit.value.unitTo }}
                    </span>
                    <span class="no-value" *ngIf="!unit.value.unitFrom || !unit.value.unitTo">—</span>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-col"></th>
                <td mat-cell *matCellDef="let unit; let i = index" class="actions-col">
                    <button mat-icon-button [class.active-edit]="expandedUnit === unit"
                            (click)="toggleUnitExpand(unit); $event.stopPropagation()"
                            matTooltip="Edit">
                        <mat-icon>{{ expandedUnit === unit ? 'expand_less' : 'edit' }}</mat-icon>
                    </button>
                    <button mat-icon-button color="warn"
                            (click)="removeUnit(i); $event.stopPropagation()"
                            matTooltip="Delete">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <!-- Expanded Detail Column -->
            <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let unit" [attr.colspan]="unitDisplayedColumns.length" class="detail-cell">
                    <div *ngIf="expandedUnit === unit" class="expanded-form-wrapper">
                        <rdio-scanner-admin-unit
                            [form]="unit"
                            (remove)="removeUnit(units.indexOf(unit))">
                        </rdio-scanner-admin-unit>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="unitDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: unitDisplayedColumns;"
                class="data-row"
                [class.row-expanded]="expandedUnit === row"
                cdkDrag [cdkDragData]="row"
                (click)="toggleUnitExpand(row)">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail'];" class="detail-row"
                [class.row-hidden]="expandedUnit !== row">
            </tr>

        </mat-table>
    </div>
</div>

</ng-container>
